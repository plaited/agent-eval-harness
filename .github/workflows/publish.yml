name: Publish

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      next:
        description: "Prerelease number (optional, creates x.y.z-next.N)"
        required: false

jobs:
  publish:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Validate inputs
        env:
          INPUT_NEXT: ${{ github.event.inputs.next }}
        run: |
          # SECURITY: Validate all inputs before use to prevent injection
          # Using env vars instead of direct interpolation to prevent shell injection

          # Validate next is a number if provided
          if [[ -n "$INPUT_NEXT" ]] && ! echo "$INPUT_NEXT" | grep -qE '^[0-9]+$'; then
            echo "::error::Invalid next value: $INPUT_NEXT"
            echo "::error::Expected: number (e.g., 1, 2, 3)"
            exit 1
          fi

          echo "âœ“ Input validation passed"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node.js (for NPM OIDC)
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          registry-url: https://registry.npmjs.org
          check-latest: true

      - uses: oven-sh/setup-bun@v1

      - name: Setup
        run: |
          bun install

      - name: Compute version
        id: set_version
        env:
          INPUT_BUMP: ${{ github.event.inputs.bump }}
          INPUT_NEXT: ${{ github.event.inputs.next }}
        run: |
          # Read current version from package.json
          current=$(node -p "require('./package.json').version")
          echo "Current version: $current"

          # Extract major.minor.patch from current version (strip any prerelease suffix)
          base=$(echo "$current" | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+')
          if [[ -z "$base" ]]; then
            echo "::error::Invalid current version format in package.json: $current"
            echo "::error::Expected: X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi
          IFS='.' read -r major minor patch <<< "$base"

          # Apply bump
          case "$INPUT_BUMP" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          version="${major}.${minor}.${patch}"

          if [[ -n "$INPUT_NEXT" ]]; then
            version="${version}-next.${INPUT_NEXT}"
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Computed version: $version"

      - name: Configure Git
        env:
          GIT_AUTHOR_NAME: ${{ github.actor }}
          GIT_AUTHOR_EMAIL: ${{ github.actor }}@users.noreply.github.com
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

      - name: Version
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          VERSION: ${{ steps.set_version.outputs.version }}
          IS_PRERELEASE: ${{ steps.set_version.outputs.is_prerelease }}
        run: |
          npm version --no-git-tag-version "$VERSION"

          git add -A
          git commit -m "ci: publish [skip ci]"
          git push

          # Create GitHub release
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            gh release create "v$VERSION" --generate-notes --prerelease
          else
            gh release create "v$VERSION" --generate-notes
          fi

      - name: Publish to NPM (Trusted Publishing)
        env:
          IS_PRERELEASE: ${{ steps.set_version.outputs.is_prerelease }}
        run: |
          # NPM trusted publishing uses OIDC token automatically
          # Provenance attestations are generated automatically (npm >=11.5.1)
          # No NPM_TOKEN secret needed - authentication via GitHub OIDC

          if [[ "$IS_PRERELEASE" == "true" ]]; then
            echo "Publishing as next (prerelease)"
            npm publish --access public --tag next
          else
            echo "Publishing as latest (stable)"
            npm publish --access public
          fi
